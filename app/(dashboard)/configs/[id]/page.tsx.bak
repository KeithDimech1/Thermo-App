/**
 * Test Configuration Detail Page
 *
 * Displays comprehensive information about a specific test configuration including:
 * - Full CV performance breakdown
 * - Statistical measures (mean, median, std dev)
 * - QC sample information
 * - Assay and manufacturer details
 * - Educational components (with Dimech 2021 context)
 */

import Link from 'next/link';
import { notFound } from 'next/navigation';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/Card';
import { Badge } from '@/components/ui/Badge';
import { Button } from '@/components/ui/Button';
import { MarkerInfoPanel } from '@/components/education/MarkerInfoPanel';
import { CVExplainerCard } from '@/components/education/CVExplainerCard';
import { MethodologyTooltip } from '@/components/education/MethodologyTooltip';

// Types
interface TestConfigDetail {
  config_id: number;
  test_type: string;
  events_examined: number;
  quality_rating: 'excellent' | 'good' | 'acceptable' | 'poor';

  marker_id: number;
  marker_name: string;
  antibody_type: string | null;
  pathogen_id: number | null;
  pathogen_name: string | null;
  category_id: number | null;
  category_name: string | null;

  assay_id: number;
  assay_name: string;
  platform: string | null;
  methodology: string | null;

  manufacturer_id: number | null;
  manufacturer_name: string | null;

  qc_sample_id: number;
  qc_sample_name: string;

  cv_lt_10_count: number | null;
  cv_lt_10_percentage: number | null;
  cv_10_15_count: number | null;
  cv_10_15_percentage: number | null;
  cv_15_20_count: number | null;
  cv_15_20_percentage: number | null;
  cv_gt_20_count: number | null;
  cv_gt_20_percentage: number | null;
  mean_cv: number | null;
}

// Fetch config data
async function fetchConfigData(id: string): Promise<TestConfigDetail | null> {
  try {
    const baseUrl = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3000';
    const response = await fetch(`${baseUrl}/api/configs/${id}`, {
      cache: 'no-store',
    });

    if (!response.ok) {
      if (response.status === 404) return null;
      throw new Error('Failed to fetch config');
    }

    const result = await response.json();
    return result.data;
  } catch (error) {
    console.error('Error fetching config:', error);
    return null;
  }
}

// Calculate total events from counts
function calculateTotalEvents(config: TestConfigDetail): number {
  return (
    (config.cv_lt_10_count || 0) +
    (config.cv_10_15_count || 0) +
    (config.cv_15_20_count || 0) +
    (config.cv_gt_20_count || 0)
  );
}

// Main page component
export default async function ConfigDetailPage({
  params,
}: {
  params: { id: string };
}) {
  const config = await fetchConfigData(params.id);

  if (!config) {
    notFound();
  }

  const totalEvents = calculateTotalEvents(config);

  return (
    <div className="space-y-8">
      {/* Breadcrumb */}
      <div className="flex items-center gap-2 text-sm text-gray-600">
        <Link href="/assays" className="hover:text-blue-600">
          ‚Üê Back to Assays
        </Link>
      </div>

      {/* Header */}
      <div className="flex items-start justify-between">
        <div className="flex-1">
          <h1 className="text-4xl font-bold text-gray-900">
            {config.marker_name}
          </h1>
          <div className="flex items-center gap-3 mt-3">
            <Link
              href={`/markers/${config.marker_id}`}
              className="text-lg text-blue-600 hover:text-blue-700 hover:underline"
            >
              {config.marker_name}
            </Link>
            <span className="text-gray-400">‚Ä¢</span>
            <Link
              href={`/manufacturers/${config.manufacturer_id}`}
              className="text-lg text-gray-600 hover:text-blue-600 hover:underline"
            >
              {config.manufacturer_name}
            </Link>
          </div>
          <div className="flex items-center gap-2 mt-2">
            {config.antibody_type && (
              <Badge variant="default" size="md">
                {config.antibody_type}
              </Badge>
            )}
            {config.category_name && (
              <Badge variant="default" size="md">
                {config.category_name}
              </Badge>
            )}
            <Badge
              variant={config.quality_rating}
              size="md"
            >
              {config.quality_rating.charAt(0).toUpperCase() +
                config.quality_rating.slice(1)}
            </Badge>
          </div>
        </div>

        <div className="flex gap-2">
          <Button variant="secondary" size="md">
            Add to Compare
          </Button>
          <Button variant="secondary" size="md">
            Export Data
          </Button>
        </div>
      </div>

      {/* Test Configuration Summary */}
      <Card variant="bordered">
        <CardHeader>
          <CardTitle>Test Configuration Summary</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
            <div>
              <div className="text-sm text-gray-600 mb-1">Assay</div>
              <div className="font-medium text-gray-900">{config.assay_name}</div>
              {config.platform && (
                <div className="text-sm text-gray-600 mt-1">{config.platform}</div>
              )}
            </div>
            <div>
              <div className="text-sm text-gray-600 mb-1">Methodology</div>
              {config.methodology ? (
                <MethodologyTooltip methodology={config.methodology}>
                  {config.methodology}
                </MethodologyTooltip>
              ) : (
                <div className="text-gray-500"></div>
              )}
            </div>
            <div>
              <div className="text-sm text-gray-600 mb-1">QC Sample</div>
              <div className="font-medium text-gray-900">{config.qc_sample_name}</div>
            </div>
            <div>
              <div className="text-sm text-gray-600 mb-1">Test Type</div>
              <Badge variant="default" size="sm">
                {config.test_type.toUpperCase()}
              </Badge>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* CV Performance Breakdown */}
      <Card variant="bordered">
        <CardHeader>
          <CardTitle>CV Performance Breakdown</CardTitle>
        </CardHeader>
        <CardContent className="space-y-6">
          {/* Statistics */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
            <div className="text-center">
              <div className="text-3xl font-bold text-gray-900">
                {config.events_examined || totalEvents}
              </div>
              <div className="text-sm text-gray-600 mt-1">Events Examined</div>
            </div>
            <div className="text-center">
              <div className="text-3xl font-bold text-blue-600">
                {config.mean_cv?.toFixed(2) || ''}%
              </div>
              <div className="text-sm text-gray-600 mt-1">Mean CV</div>
            </div>
            <div className="text-center">
              <div className="text-3xl font-bold text-green-600">
                {config.cv_lt_10_percentage?.toFixed(1) || ''}%
              </div>
              <div className="text-sm text-gray-600 mt-1">CV &lt;10%</div>
            </div>
            <div className="text-center">
              <div className="text-3xl font-bold text-red-600">
                {config.cv_gt_20_percentage?.toFixed(1) || ''}%
              </div>
              <div className="text-sm text-gray-600 mt-1">CV &gt;20%</div>
            </div>
          </div>

          {/* CV Distribution */}
          <div>
            <h3 className="font-semibold text-gray-900 mb-3">
              CV Distribution
            </h3>
            <div className="space-y-3">
              {/* CV <10% */}
              <div>
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm font-medium text-gray-700">
                    CV &lt;10% (Excellent)
                  </span>
                  <span className="text-sm font-bold text-green-600">
                    {config.cv_lt_10_count || 0} events ({config.cv_lt_10_percentage?.toFixed(1) || 0}%)
                  </span>
                </div>
                <div className="h-3 bg-gray-100 rounded-full overflow-hidden">
                  <div
                    className="h-full bg-green-500"
                    style={{ width: `${config.cv_lt_10_percentage || 0}%` }}
                  />
                </div>
              </div>

              {/* CV 10-15% */}
              <div>
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm font-medium text-gray-700">
                    CV 10-15% (Good)
                  </span>
                  <span className="text-sm font-bold text-blue-600">
                    {config.cv_10_15_count || 0} events ({config.cv_10_15_percentage?.toFixed(1) || 0}%)
                  </span>
                </div>
                <div className="h-3 bg-gray-100 rounded-full overflow-hidden">
                  <div
                    className="h-full bg-blue-500"
                    style={{ width: `${config.cv_10_15_percentage || 0}%` }}
                  />
                </div>
              </div>

              {/* CV 15-20% */}
              <div>
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm font-medium text-gray-700">
                    CV 15-20% (Acceptable)
                  </span>
                  <span className="text-sm font-bold text-amber-600">
                    {config.cv_15_20_count || 0} events ({config.cv_15_20_percentage?.toFixed(1) || 0}%)
                  </span>
                </div>
                <div className="h-3 bg-gray-100 rounded-full overflow-hidden">
                  <div
                    className="h-full bg-amber-500"
                    style={{ width: `${config.cv_15_20_percentage || 0}%` }}
                  />
                </div>
              </div>

              {/* CV >20% */}
              <div>
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm font-medium text-gray-700">
                    CV &gt;20% (Poor)
                  </span>
                  <span className="text-sm font-bold text-red-600">
                    {config.cv_gt_20_count || 0} events ({config.cv_gt_20_percentage?.toFixed(1) || 0}%)
                  </span>
                </div>
                <div className="h-3 bg-gray-100 rounded-full overflow-hidden">
                  <div
                    className="h-full bg-red-500"
                    style={{ width: `${config.cv_gt_20_percentage || 0}%` }}
                  />
                </div>
              </div>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Educational Components */}
      <div className="grid md:grid-cols-2 gap-6">
        {/* Clinical Context */}
        <MarkerInfoPanel
          marker={{
            name: config.marker_name,
            pathogen_name: config.pathogen_name,
            category_name: config.category_name,
            antibody_type: config.antibody_type,
          }}
          variant="full"
        />

        {/* CV Explainer */}
        <CVExplainerCard variant="full" showExamples={true} showReference={true} />
      </div>

      {/* Quality Assessment */}
      <Card variant="bordered">
        <CardHeader>
          <CardTitle>Quality Assessment</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="flex items-start gap-4">
            <Badge variant={config.quality_rating} size="lg">
              {config.quality_rating.charAt(0).toUpperCase() +
                config.quality_rating.slice(1)}
            </Badge>
            <div className="flex-1">
              <h4 className="font-semibold text-gray-900 mb-1">
                Overall Rating: {config.quality_rating.charAt(0).toUpperCase() + config.quality_rating.slice(1)}
              </h4>
              <p className="text-sm text-gray-600">
                {config.quality_rating === 'excellent' &&
                  'This configuration demonstrates excellent precision with ‚â•95% of measurements achieving CV <10%. Suitable for critical diagnostic applications.'}
                {config.quality_rating === 'good' &&
                  'This configuration shows good precision with most measurements achieving acceptable CV levels. Suitable for routine diagnostic use.'}
                {config.quality_rating === 'acceptable' &&
                  'This configuration demonstrates acceptable precision but may not meet requirements for critical applications. Additional validation recommended.'}
                {config.quality_rating === 'poor' &&
                  'This configuration shows poor precision with significant variability. Not recommended for clinical use without investigation and improvement.'}
              </p>
            </div>
          </div>

          {/* Data Confidence */}
          <div className="pt-4 border-t border-gray-200">
            <div className="flex items-start gap-3 text-sm">
              <div className="flex-shrink-0 text-blue-600 mt-0.5">9</div>
              <div className="text-gray-600">
                <span className="font-medium text-gray-900">Data Confidence: </span>
                {(config.events_examined || totalEvents) >= 50 && 'High confidence - based on ‚â•50 QC events'}
                {(config.events_examined || totalEvents) >= 30 && (config.events_examined || totalEvents) < 50 && 'Medium confidence - based on 30-49 QC events'}
                {(config.events_examined || totalEvents) < 30 && 'Limited confidence - based on <30 QC events. Results should be interpreted with caution.'}
              </div>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
