# Code Quality Analysis Report

**Last Check:** 2025-11-19 07:27:59
**Generated by:** `/bigtidycheck`
**Project:** AusGeochem Thermochronology Database
**Total Issues Found:** 12

---

## ğŸ“Š Summary

| Severity | Count | Action |
|----------|-------|--------|
| ğŸ”´ Critical | 1 | Auto-logged to error system |
| ğŸŸ¡ Medium | 5 | User selection for logging |
| ğŸ”µ Small | 6 | Tracked in readme only |

---

## ğŸ”´ Critical Issues (P0)

### 1. Security Vulnerability: glob Command Injection â†’ **ERROR-012**

**Severity:** High (CVSS 7.5)
**Package:** `glob` v10.3.7-10.4.5 (transitive dependency)
**Via:** eslint-config-next â†’ @next/eslint-plugin-next â†’ glob
**CVE:** [GHSA-5j98-mcp5-4vw2](https://github.com/advisories/GHSA-5j98-mcp5-4vw2)

**Issue:**
glob CLI: Command injection via -c/--cmd executes matches with shell:true

**Impact:**
- High severity security vulnerability
- Command injection attack vector (CWE-78)
- Affects dev dependencies (eslint-config-next)

**Fix Available:** âœ… Yes (npm audit fix)

**Suggested Fix:**
```bash
npm audit fix
# or update eslint-config-next to latest version
npm install eslint-config-next@latest
```

**Status:** ğŸ”´ Open â†’ Logged
**Debug Log:** `build-data/errors/debug/ER-012-security-vulnerability-glob-command-injection-cve-ghsa-5j98-mcp5-4vw2.md`
**Track:** Use `/debug-mode` to fix, `/resolve ERROR-012` when done

---

## ğŸŸ¡ Medium Issues (P1-P2)

### 2. Unused Exports: Dead Code Detection â†’ **ERROR-013**

**Severity:** Medium
**Tool:** ts-prune
**Files Affected:** Multiple (lib/db/, lib/types/, app/api/, components/)

**Key Examples:**
- `lib/db/connection.ts:167` - `transaction()` (unused)
- `lib/db/connection.ts:193` - `testConnection()` (unused)
- `lib/db/connection.ts:212` - `closePool()` (unused)
- `lib/db/connection.ts:224` - `getPoolStats()` (unused)
- `lib/db/earthbank-queries.ts:155` - `getFTDatapointByName()` (unused)
- `lib/db/earthbank-queries.ts:163` - `getFTDatapointsFiltered()` (unused)
- `lib/db/earthbank-queries.ts:244` - `getHeDatapointByName()` (unused)
- `lib/db/earthbank-queries.ts:305` - `getFTTrackLengthDataBySample()` (unused)
- `lib/db/earthbank-queries.ts:382` - `getSampleCountByMineral()` (unused)
- `lib/db/earthbank-queries.ts:398` - `getAgeDistribution()` (unused)
- `lib/db/queries.ts:121` - `getSampleSummaries()` (unused)
- `lib/db/queries.ts:174` - `getSampleDetail()` (unused)
- `lib/db/queries.ts:233` - `getFTCountDataByDatapoint()` (unused)
- `lib/types/earthbank-types.ts:302` - `EarthBankFTSingleGrainAge` (unused)
- `lib/types/thermo-data.ts:193` - `SamplePersonRole` (unused)
- `lib/types/thermo-data.ts:239` - `Mount` (unused)

**Impact:**
- Code bloat (~20-30% of database query functions unused)
- Maintenance burden (updating code that's never called)
- Confusion for new developers

**Suggested Fix:**
1. Review each flagged export
2. Remove truly unused code
3. Keep functions intended for future use (mark with comment)
4. Consider creating a "future features" module for planned exports

**Status:** ğŸŸ¡ Needs Review â†’ Logged
**Debug Log:** `build-data/errors/debug/ER-013-dead-code-99-unused-exports-in-database-layer.md`
**Track:** Use `/debug-mode` to fix, `/resolve ERROR-013` when done

---

### 3. Console.log/Console.error in Production Code â†’ **ERROR-014**

**Severity:** Medium
**Files Affected:** 12 files

**Locations:**
- `app/api/tables/[name]/route.ts:168` - console.error
- `app/api/analysis/ages/route.ts:56` - console.error
- `app/api/datasets/files/[id]/route.ts:59,93` - console.error (2x)
- `app/api/datasets/[id]/supplementary-files/route.ts:82` - console.error
- `app/api/datasets/[id]/table-counts/route.ts:84` - console.error
- `app/api/datasets/[id]/download-all/route.ts:63,83` - console.error (2x)
- `app/api/samples/route.ts:66` - console.error
- `app/api/samples/[id]/route.ts:45` - console.error
- `app/api/stats/route.ts:27` - console.error
- `lib/db/fair-compliance.ts:99,126` - console.error (2x)
- `lib/db/connection.ts:79,84,126-128,180,196` - console.error + console.log (6x)

**Impact:**
- Logs not captured by proper logging system
- Sensitive data might leak to browser console
- Performance overhead in production
- No log aggregation/monitoring

**Suggested Fix:**
Replace with proper logging library:
```typescript
// Instead of:
console.error('Error fetching samples:', error);

// Use:
logger.error('Error fetching samples', { error, context: { route: '/api/samples' } });
```

Consider: Winston, Pino, or Next.js built-in logging

**Status:** ğŸŸ¡ Open â†’ Logged
**Debug Log:** `build-data/errors/debug/ER-014-production-code-console-logging-instead-of-proper-logger.md`
**Track:** Use `/debug-mode` to fix, `/resolve ERROR-014` when done

---

### 4. Unused Dev Dependencies (5 packages)

**Severity:** Medium (code bloat)
**Tool:** depcheck

**Packages:**
1. `@types/react-dom` - Appears unused
2. `autoprefixer` - Appears unused (but likely needed for Tailwind)
3. `eslint` - Appears unused (but required for Next.js)
4. `eslint-config-next` - Appears unused (but required)
5. `postcss` - Appears unused (but needed for Tailwind)

**Note:** Some of these are likely false positives (build tools, linters). Manual review needed.

**Impact:**
- Slightly larger node_modules (minor)
- Potential confusion about what's actually needed

**Suggested Fix:**
1. Review each package
2. Keep build tooling (autoprefixer, postcss)
3. Remove truly unused packages

**Status:** ğŸŸ¡ Needs Manual Review

---

### 5. Outdated Packages â†’ **ERROR-015**

**Severity:** Medium
**Tool:** npm outdated

**Packages:**

| Package | Current | Wanted | Latest | Priority |
|---------|---------|--------|--------|----------|
| eslint-config-next | 14.2.33 | 14.2.33 | 16.0.3 | High (security fix) |
| @types/node | 20.19.24 | 20.19.25 | 24.10.1 | Medium |
| @types/react | 18.3.26 | 18.3.27 | 19.2.6 | Low (major bump) |
| @types/react-dom | 18.3.7 | 18.3.7 | 19.2.3 | Low (major bump) |
| eslint | 8.57.1 | 8.57.1 | 9.39.1 | Medium |
| lucide-react | 0.553.0 | 0.553.0 | 0.554.0 | Low |
| tailwindcss | 3.4.18 | 3.4.18 | 4.1.17 | Low (major bump) |

**Impact:**
- Missing security patches (eslint-config-next)
- Potential missing features
- Compatibility issues with future dependencies

**Suggested Fix:**
```bash
# Critical: Update eslint-config-next for security fix
npm install eslint-config-next@latest

# Patch updates (safe)
npm update @types/node lucide-react

# Major updates (test carefully)
# npm install @types/react@19 @types/react-dom@19  # Wait for Next.js compatibility
# npm install tailwindcss@4  # Major breaking changes
```

**Status:** ğŸŸ¡ Needs Update â†’ Logged
**Debug Log:** `build-data/errors/debug/ER-015-dependency-maintenance-7-outdated-packages-security-risk.md`
**Track:** Use `/debug-mode` to fix, `/resolve ERROR-015` when done

---

### 6. tsconfig.json Parsing Error in depcheck

**Severity:** Low-Medium
**Tool:** depcheck

**Error:**
```
SyntaxError: Expected property name or '}' in JSON at position 29 (line 3 column 5)
```

**Issue:**
tsconfig.json contains comments (valid for TypeScript, invalid for JSON parsers)

**Impact:**
- depcheck cannot fully analyze TypeScript imports
- Some unused dependencies might be missed

**Suggested Fix:**
This is expected behavior - tsconfig.json allows comments. Not a real issue.

**Status:** ğŸ”µ Low Priority / False Positive

---

## ğŸ”µ Small Issues (P3)

### 7. âœ… TypeScript Compilation: ZERO ERRORS

**Status:** âœ… Excellent
**Tool:** tsc --noEmit

All TypeScript files compile without errors. Type safety is excellent.

---

### 8. âœ… No Hardcoded Secrets Found

**Status:** âœ… Excellent
**Tool:** grep for API_KEY, SECRET, PASSWORD patterns

No hardcoded API keys, secrets, or passwords detected in source code.

---

### 9. âœ… No Schema Mismatch Issues

**Status:** âœ… Excellent
**Tool:** grep for old column references

No references to removed/renamed database columns detected. EarthBank migration is clean.

---

### 10. âœ… No TODO/FIXME Comments

**Status:** âœ… Excellent
**Tool:** grep for TODO, FIXME, XXX, HACK

No technical debt markers found in code.

---

### 11. Database Connection Pool Functions (Unused but Intentional)

**Severity:** Low
**Files:** lib/db/connection.ts

**Exports marked unused but likely needed:**
- `testConnection()` - Used in scripts/db/test-connection.ts
- `closePool()` - Cleanup function (needed for graceful shutdown)
- `getPoolStats()` - Monitoring/debugging function
- `transaction()` - Advanced feature (may be needed for future use)

**Status:** ğŸ”µ Keep (utility functions)

---

### 12. Type Definitions (Unused but Part of Schema)

**Severity:** Low
**Files:** lib/types/earthbank-types.ts, lib/types/thermo-data.ts

**Unused types likely part of complete schema:**
- `EarthBankFTSingleGrainAge` - Part of EarthBank spec
- `SamplePersonRole` - Database table type
- `Mount` - Database table type
- `FTBinnedLengthData` - Database table type

**Status:** ğŸ”µ Keep (schema completeness)

---

## ğŸ“ˆ Overall Code Quality: EXCELLENT

**Highlights:**
- âœ… **Zero TypeScript errors** - Strong type safety
- âœ… **No hardcoded secrets** - Good security hygiene
- âœ… **No schema mismatches** - Clean migration (IDEA-014)
- âœ… **No technical debt markers** - Well-maintained code

**Areas for Improvement:**
- ğŸŸ¡ **Security vulnerability** - Update eslint-config-next (HIGH PRIORITY)
- ğŸŸ¡ **Dead code** - ~20-30% of database queries unused (review needed)
- ğŸŸ¡ **Console logging** - Replace with proper logging system
- ğŸŸ¡ **Package updates** - Some outdated dependencies

**Recommended Priority:**
1. **Fix glob vulnerability** (npm audit fix) - 5 minutes
2. **Update eslint-config-next** - 5 minutes
3. **Review unused exports** - 2-4 hours (create backlog)
4. **Implement logging library** - 2-4 hours
5. **Update packages** - 1 hour + testing

---

## ğŸ“ Files Updated

This analysis has been saved to:
- `readme/code-quality/bigtidycheck-2025-11-19.md` (this file)

---

## ğŸ”„ Next Steps

1. **Review critical/medium issues** (listed above)
2. **Decide which issues to log** to error tracking system
3. **Run fixes** for security vulnerability and package updates
4. **Re-run** `/bigtidycheck` after fixes to verify

---

**Generated by:** `/bigtidycheck` automated code quality analysis
**Last Updated:** 2025-11-19 07:27:59
**Next Check:** Run `/bigtidycheck` anytime to refresh analysis
