# Security Issue: xlsx Library Vulnerabilities

**Created:** 2025-11-21 19:50:00
**Severity:** üî¥ HIGH
**Status:** üü° Documented - Mitigation Needed
**Category:** Dependency Security

---

## Summary

The `xlsx` library used for Excel file processing has **2 high-severity security vulnerabilities**:
1. **Prototype Pollution** (CVSS 7.8)
2. **Regular Expression Denial of Service (ReDoS)** (CVSS 7.5)

**No automatic fix is currently available** from npm audit.

---

## Vulnerability Details

### 1. Prototype Pollution (GHSA-4r6h-8v6p-xvw6)

**CVE:** GHSA-4r6h-8v6p-xvw6
**CVSS Score:** 7.8 (High)
**CWE:** CWE-1321 (Improperly Controlled Modification of Object Prototype Attributes)
**Affected Versions:** < 0.19.3
**Attack Vector:** Local (requires user to upload malicious Excel file)

**Description:**
Prototype pollution vulnerability allows attackers to inject properties into Object.prototype through maliciously crafted Excel files.

**Potential Impact:**
- Unauthorized access to data
- Code execution in the application context
- Application crashes

---

### 2. Regular Expression Denial of Service (GHSA-5pgg-2g8v-p4x9)

**CVE:** GHSA-5pgg-2g8v-p4x9
**CVSS Score:** 7.5 (High)
**CWE:** CWE-1333 (Inefficient Regular Expression Complexity)
**Affected Versions:** < 0.20.2
**Attack Vector:** Network (malicious file uploaded via web interface)

**Description:**
Inefficient regular expression in xlsx library can cause CPU exhaustion when processing maliciously crafted Excel files.

**Potential Impact:**
- Application becomes unresponsive
- Denial of service for other users
- Server resource exhaustion

---

## Current Usage in Application

**Files Using xlsx:**

1. **`lib/utils/file-upload.ts`**
   - File upload utilities
   - Processes user-uploaded Excel files

2. **`app/api/extraction/*/route.ts`**
   - PDF extraction workflow
   - Processes EarthBank template Excel files

3. **Import scripts** (`scripts/db/import-*`)
   - Batch data imports
   - Processes Excel templates

**Risk Level:** MEDIUM-HIGH
- Users can upload Excel files via web interface
- Files are processed server-side
- No current validation of Excel file contents

---

## Mitigation Options

### Option 1: Switch to Alternative Library (RECOMMENDED)

**Safer Alternatives:**

**A) `exceljs` (Most Popular)**
- ‚úÖ Actively maintained
- ‚úÖ No known high-severity vulnerabilities
- ‚úÖ Similar API to xlsx
- ‚úÖ Full Excel 2007+ support
- üì¶ `npm install exceljs`

**B) `node-xlsx` (Lightweight)**
- ‚úÖ Simpler API
- ‚úÖ Smaller package size
- ‚ö†Ô∏è Limited features (basic read/write only)
- üì¶ `npm install node-xlsx`

**C) `@fast-excel/parse` (Performance-focused)**
- ‚úÖ Fast streaming parser
- ‚úÖ Good for large files
- ‚ö†Ô∏è Parse-only (no write support)
- üì¶ `npm install @fast-excel/parse`

**Migration Effort:** Medium (1-2 days)
- Update file-upload.ts
- Update extraction APIs
- Update import scripts
- Test all Excel file processing

---

### Option 2: Input Validation & Sandboxing

**If xlsx must be kept:**

**Implement strict validation:**
```typescript
// Before processing any Excel file
async function validateExcelFile(file: Buffer): Promise<void> {
  // Check file size (prevent memory exhaustion)
  const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
  if (file.length > MAX_FILE_SIZE) {
    throw new Error('Excel file too large');
  }

  // Check magic bytes (detect non-Excel files)
  const header = file.slice(0, 4).toString('hex');
  const validHeaders = [
    'd0cf11e0', // Legacy .xls
    '504b0304'  // Modern .xlsx (ZIP format)
  ];

  if (!validHeaders.some(h => header.startsWith(h))) {
    throw new Error('Invalid Excel file format');
  }

  // Limit worksheet count
  const workbook = XLSX.read(file, { sheetRows: 1 });
  if (workbook.SheetNames.length > 10) {
    throw new Error('Too many worksheets (max 10)');
  }

  // Limit row count
  for (const sheetName of workbook.SheetNames) {
    const sheet = workbook.Sheets[sheetName];
    const range = XLSX.utils.decode_range(sheet['!ref'] || 'A1');
    const rowCount = range.e.r - range.s.r + 1;

    if (rowCount > 10000) {
      throw new Error(`Sheet "${sheetName}" has too many rows (max 10000)`);
    }
  }
}
```

**Sandbox Excel processing:**
```typescript
// Process Excel files in separate worker thread
import { Worker } from 'worker_threads';

async function processExcelInSandbox(file: Buffer): Promise<any> {
  return new Promise((resolve, reject) => {
    const worker = new Worker('./excel-worker.js', {
      workerData: file,
      resourceLimits: {
        maxOldGenerationSizeMb: 512, // Memory limit
        maxYoungGenerationSizeMb: 128
      }
    });

    const timeout = setTimeout(() => {
      worker.terminate();
      reject(new Error('Excel processing timeout (30s)'));
    }, 30000);

    worker.on('message', (result) => {
      clearTimeout(timeout);
      resolve(result);
    });

    worker.on('error', reject);
  });
}
```

**Migration Effort:** Medium (1-2 days)
- Implement validation layer
- Add sandboxing to all Excel processing
- Test with various file types
- Monitor performance impact

---

### Option 3: Disable User Uploads (Temporary)

**Quick mitigation until proper fix:**
- Disable Excel file uploads via web UI
- Only allow admin/trusted users to import Excel files
- Use command-line import scripts for EarthBank templates

**Migration Effort:** Low (few hours)
**Trade-off:** Limits functionality

---

## Recommended Action Plan

**Phase 1: Immediate (This Sprint)**
1. ‚úÖ Document vulnerability (this file)
2. ‚ö†Ô∏è Add file size limits to uploads (quick win)
3. ‚ö†Ô∏è Add warning banner to upload UI about file validation

**Phase 2: Short-term (Next 2 weeks)**
1. Research `exceljs` compatibility with current code
2. Create proof-of-concept migration for one module
3. Performance test with real EarthBank templates

**Phase 3: Long-term (Next Sprint)**
1. Migrate all xlsx usage to `exceljs`
2. Remove xlsx dependency
3. Re-run security audit
4. Update documentation

---

## Current Status

**Decision Needed:**
- [ ] Switch to `exceljs` (recommended)
- [ ] Implement validation + sandboxing
- [ ] Disable user uploads temporarily
- [ ] Accept risk and monitor

**Owner:** TBD
**Target Date:** TBD

---

## References

- **GHSA-4r6h-8v6p-xvw6:** https://github.com/advisories/GHSA-4r6h-8v6p-xvw6
- **GHSA-5pgg-2g8v-p4x9:** https://github.com/advisories/GHSA-5pgg-2g8v-p4x9
- **exceljs:** https://github.com/exceljs/exceljs
- **npm audit report:** Run `npm audit` for latest status

---

**Last Updated:** 2025-11-21 19:50:00
**Found by:** `/bigtidycheck` - Post-Supabase migration code quality analysis
