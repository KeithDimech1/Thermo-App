#!/bin/bash
# Auto-shutdown wrapper for development processes
# Usage: ./scripts/dev-timed [timeout_minutes] <command>
# Example: ./scripts/dev-timed 60 npm run dev

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Default timeout: 60 minutes
DEFAULT_TIMEOUT_MINUTES=60

# Parse timeout if first arg is a number
if [[ "$1" =~ ^[0-9]+$ ]]; then
    TIMEOUT_MINUTES="$1"
    shift
else
    TIMEOUT_MINUTES="$DEFAULT_TIMEOUT_MINUTES"
fi

TIMEOUT_SECONDS=$((TIMEOUT_MINUTES * 60))

# Get the command to run
if [ $# -eq 0 ]; then
    echo -e "${RED}Error: No command specified${NC}"
    echo ""
    echo "Usage: $0 [timeout_minutes] <command>"
    echo ""
    echo "Examples:"
    echo "  $0 npm run dev                    # 60-minute timeout (default)"
    echo "  $0 30 npm run dev                 # 30-minute timeout"
    echo "  $0 120 npx tsx scripts/long.ts    # 2-hour timeout"
    echo "  $0 psql \"\$DATABASE_URL\"           # 60-minute psql session"
    exit 1
fi

COMMAND="$*"

echo -e "${BLUE}=== Dev-Timed Wrapper ===${NC}"
echo -e "Command:  ${GREEN}$COMMAND${NC}"
echo -e "Timeout:  ${YELLOW}$TIMEOUT_MINUTES minutes${NC}"
echo -e "Started:  $(date '+%Y-%m-%d %H:%M:%S')"
echo -e "${BLUE}=========================${NC}"
echo ""

# Track PID file
PID_FILE="/tmp/dev-timed-$$.pid"

# Cleanup function
cleanup() {
    if [ -f "$PID_FILE" ]; then
        PROCESS_PID=$(cat "$PID_FILE")
        if ps -p "$PROCESS_PID" > /dev/null 2>&1; then
            echo ""
            echo -e "${YELLOW}Cleaning up process $PROCESS_PID...${NC}"

            # Kill process group (includes child processes)
            pkill -TERM -P "$PROCESS_PID" 2>/dev/null || true
            kill -TERM "$PROCESS_PID" 2>/dev/null || true

            # Wait up to 5 seconds for graceful shutdown
            for i in {1..5}; do
                if ! ps -p "$PROCESS_PID" > /dev/null 2>&1; then
                    break
                fi
                sleep 1
            done

            # Force kill if still running
            if ps -p "$PROCESS_PID" > /dev/null 2>&1; then
                echo -e "${RED}Force killing process...${NC}"
                pkill -KILL -P "$PROCESS_PID" 2>/dev/null || true
                kill -KILL "$PROCESS_PID" 2>/dev/null || true
            fi

            echo -e "${GREEN}Process terminated${NC}"
        fi
        rm -f "$PID_FILE"
    fi
}

# Set up trap for cleanup
trap cleanup EXIT INT TERM

# Start the command in background
eval "$COMMAND" &
PROCESS_PID=$!

# Save PID
echo "$PROCESS_PID" > "$PID_FILE"

echo -e "${GREEN}Process started with PID: $PROCESS_PID${NC}"
echo -e "${YELLOW}Will auto-shutdown at: $(date -v+${TIMEOUT_MINUTES}M '+%H:%M:%S')${NC}"
echo ""

# Monitor process
START_TIME=$(date +%s)

while ps -p "$PROCESS_PID" > /dev/null 2>&1; do
    ELAPSED=$(($(date +%s) - START_TIME))

    if [ "$ELAPSED" -ge "$TIMEOUT_SECONDS" ]; then
        echo ""
        echo -e "${RED}=== TIMEOUT REACHED ===${NC}"
        echo -e "Process has been running for $TIMEOUT_MINUTES minutes"
        echo -e "Auto-shutdown initiated at: $(date '+%H:%M:%S')"
        echo -e "${RED}=======================${NC}"

        # Trigger cleanup (trap will handle it)
        exit 0
    fi

    # Show progress every 15 minutes
    if [ $((ELAPSED % 900)) -eq 0 ] && [ "$ELAPSED" -gt 0 ]; then
        MINUTES_ELAPSED=$((ELAPSED / 60))
        MINUTES_REMAINING=$((TIMEOUT_MINUTES - MINUTES_ELAPSED))
        echo -e "${BLUE}[$(date '+%H:%M:%S')] Running for ${MINUTES_ELAPSED}m | ${MINUTES_REMAINING}m remaining${NC}"
    fi

    sleep 10
done

# Process ended naturally
echo ""
echo -e "${GREEN}Process ended naturally (exit code: $?)${NC}"
ELAPSED=$(($(date +%s) - START_TIME))
MINUTES_ELAPSED=$((ELAPSED / 60))
echo -e "Total runtime: ${MINUTES_ELAPSED} minutes"
